# Kaggle MCP Server - Design Document

## プロジェクト概要

Kaggle MCP Server は、Model Context Protocol (MCP) を通じて Kaggle API の機能を LLM アプリケーションに提供するサーバー実装です。FastMCP フレームワークを使用し、コンペティション、データセット、モデルの管理機能を提供します。

## 設計目標

### 主要目標
- **統合性**: Kaggle API の主要機能を MCP プロトコル経由で利用可能にする
- **使いやすさ**: 複雑な API 操作を自然言語ベースで実行可能にする
- **セキュリティ**: API キーの安全な管理と適切な認証機構
- **拡張性**: 将来的な機能追加に対応できる柔軟な設計

### 対象ユーザー
- データサイエンティスト
- 機械学習エンジニア
- 研究者・学生
- AI アプリケーション開発者

## システムアーキテクチャ

### レイヤード構成
```
┌─────────────────────────────────────────────────────────┐
│                プレゼンテーション層                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │MCP Interface│  │Tool Handler │  │Resource     │    │
│  │             │  │             │  │Handler      │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                 ビジネスロジック層                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │Competition  │  │Dataset      │  │Model        │    │
│  │Service      │  │Service      │  │Service      │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                インフラストラクチャ層                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │Auth Manager │  │Cache Manager│  │Error Handler│    │
│  │             │  │             │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│                 データアクセス層                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │Kaggle API   │  │File System  │  │Cache Storage│    │
│  │Client       │  │Access       │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## 実装状況

### 実装済み機能

#### ツール（7個実装済み）
| ツール名 | 説明 | 実装状況 |
|---------|------|---------|
| `list_competitions` | コンペティション一覧取得 | ✅ 完了 |
| `get_competition_details` | コンペティション詳細情報 | ✅ 完了 |
| `download_competition_files` | コンペティションファイルダウンロード | ✅ 完了 |
| `search_datasets` | データセット検索 | ✅ 完了 |
| `get_dataset_details` | データセット詳細情報 | ✅ 完了 |
| `download_dataset` | データセットダウンロード | ✅ 完了 |
| `list_models` | モデル一覧取得 | ✅ 完了 |

#### リソース（2個実装済み）
| リソース名 | URI | 説明 | 実装状況 |
|-----------|-----|------|---------|
| Active Competitions | `kaggle://competitions/active` | アクティブなコンペティション | ✅ 完了 |
| Popular Datasets | `kaggle://datasets/popular` | 人気のデータセット | ✅ 完了 |

### 技術実装詳細

#### 安全なシリアライゼーション
```python
def safe_serialize(obj: Any) -> Any:
    """Kaggle API オブジェクトを JSON 互換形式に安全にシリアライゼーション"""
    # プリミティブ型の処理
    # コレクション型の処理
    # 日時オブジェクトの処理
    # enum オブジェクトの処理
    # フォールバック処理
```

#### エラーハンドリング
- `handle_kaggle_errors` デコレータによる統一的なエラー処理
- ユーザーフレンドリーなエラーメッセージ
- 詳細なログ記録

#### キャッシュシステム
- `KaggleAPICache` クラスによる TTL ベースキャッシュ
- デフォルト TTL: 300秒
- メモリ効率的な実装

## セキュリティ設計

### 認証システム
#### 認証方法
1. **環境変数方式**（推奨）
   ```bash
   export KAGGLE_USERNAME=your_username
   export KAGGLE_KEY=your_api_key
   ```

2. **設定ファイル方式**
   ```json
   # ~/.kaggle/kaggle.json
   {
       "username": "your_username",
       "key": "your_api_key"
   }
   ```

### データ保護
- API キーの安全な管理
- 入力値の検証とサニタイゼーション
- ファイルパスの制限
- 読み取り専用操作に限定

## パフォーマンス設計

### 最適化戦略
- **キャッシュ**: 頻繁にアクセスされるデータのメモリキャッシュ
- **非同期処理**: asyncio による並行処理
- **接続プール**: HTTP 接続の効率的な管理
- **ストリーミング**: 大容量ファイルの処理

### キャッシュ対象
- コンペティション一覧
- データセット検索結果
- モデル一覧
- ユーザープロファイル情報

## 技術スタック

### コア技術
- **Python**: 3.8+
- **Framework**: FastMCP
- **API Client**: Kaggle API Python クライアント
- **非同期処理**: asyncio

### 主要依存関係
- `mcp`: Model Context Protocol SDK
- `kaggle`: 公式 Kaggle API クライアント
- `python-dotenv`: 環境変数管理
- `pathlib`: ファイルパス操作

## 開発・運用

### インストール方法
```bash
# uv を使用（推奨）
uv sync

# 従来の方法
pip install kaggle fastmcp
```

### 実行方法
```bash
# uv を使用
uv run -m kaggle_mcp_server

# 開発モード
uv run mcp dev src/kaggle_mcp_server/server.py

# 直接実行
python -m kaggle_mcp_server
```

### Claude Desktop 統合
```bash
uv run mcp install src/kaggle_mcp_server/server.py --name "Kaggle MCP Server"
```

## エラー対応

### 解決済み問題
- ❌ Kaggle API オブジェクトシリアライゼーション → ✅ `safe_serialize()` 実装
- ❌ パラメータ互換性問題 → ✅ 非対応パラメータの除去
- ❌ 属性アクセスエラー → ✅ `getattr()` による安全なアクセス
- ❌ enum シリアライゼーション → ✅ 適切な enum 処理

### 現在の制限事項
- **読み取り専用**: データ変更操作は未対応
- **ディスカッション機能**: Kaggle API で未サポート
- **ファイルサイズ制限**: 大容量ダウンロードでタイムアウトの可能性
- **レート制限**: Kaggle API の制限に従う

## 今後の拡張計画

### 検討中の機能
- **書き込み操作**: コンペティション投稿機能（API サポート次第）
- **リアルタイム更新**: WebSocket サポート
- **永続化キャッシュ**: データベースバックエンド
- **メトリクス**: 使用状況分析

### アーキテクチャ改善
- **マイクロサービス化**: 機能別サービス分離
- **分散キャッシュ**: Redis 等の活用
- **監視システム**: Prometheus/Grafana 統合
- **CI/CD**: GitHub Actions 拡張

## プロジェクト構成

```
kaggle-mcp-server/
├── src/kaggle_mcp_server/
│   ├── server.py          # メインサーバー実装
│   ├── config.py          # 設定管理
│   ├── utils.py           # ユーティリティ
│   └── __init__.py
├── docs/                  # ドキュメント
├── tests/                 # テストスイート
├── pyproject.toml         # プロジェクト設定
├── CLAUDE.md             # 開発ガイドライン
└── design.md             # この設計文書
```

## 結論

Kaggle MCP Server は、包括的な設計と実装により、LLM アプリケーションと Kaggle プラットフォーム間の効率的な統合を実現しています。

### 主要な成果
- **完全実装**: 7つのツールと2つのリソースの完全実装
- **堅牢性**: 包括的なエラーハンドリングと安全なシリアライゼーション
- **パフォーマンス**: 効率的なキャッシュシステムと非同期処理
- **セキュリティ**: 安全な認証システムと入力検証

### 継続的改善
プロジェクトは継続的な改善を行い、データサイエンスコミュニティにとって価値のあるツールとして発展を続けます。ユーザーフィードバックを積極的に取り入れ、Kaggle API の進化に合わせた機能拡張を実施していきます。